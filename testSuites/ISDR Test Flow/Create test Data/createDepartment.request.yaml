id: a6af9e9c-2c1f-4d4b-8437-cdd2fe4ab82b
name: createDepartment
request:
  url:
    raw: >-
      {{API_Base_URL}}/interface/{{SYSTEM_ID}}/hospital/{{HospitalId}}/departments
    host:
      - '{{API_Base_URL}}'
    path:
      - interface
      - '{{SYSTEM_ID}}'
      - hospital
      - '{{HospitalId}}'
      - departments
  method: POST
  headers:
    - description: ''
      disabled: false
      key: Cache-Control
      value: no-cache
    - description: ''
      disabled: false
      key: Accept
      value: '*/*'
    - description: ''
      disabled: false
      key: Accept-Encoding
      value: gzip, deflate
    - description: ''
      disabled: false
      key: Connection
      value: keep-alive
  body:
    mode: raw
    modeOfBody: JSON
    raw: |-
      {
        "data": [
          {
            "path": "name",
            "value": "{{DepartmentName}}"
          }
        ],
        "name": "{{departmentName}}"
      }
  auth:
    type: bearer
    bearer:
      token: '{{idToken}}'
events:
  - listen: test
    script:
      type: javascript
      exec:
        - const depResponse = pq.response.json();
        - ''
        - // Validate department name
        - pq.test("Department Creation", () => {
        - '  pq.expect(depResponse.name).to.equal(pq.environment.get(''departmentName''));'
        - '});'
        - ''
        - // Set department ID
        - const deptId = depResponse.id;
        - pq.environment.set("departmentID", deptId);
        - ''
        - // Gather required variables
        - const baseUrl = pq.globals.get('API_Base_URL');
        - const sysId   = pq.globals.get('SYSTEM_ID');
        - const hospId  = pq.environment.get('HospitalId');
        - const bldgId  = pq.environment.get("BuildingId");
        - const idToken = pq.globals.get("idToken");
        - >-
          let url =
          `${baseUrl}/interface/${sysId}/hospital/${hospId}/buildings/${bldgId}/departments`
        - console.log(url);
        - // Send department link request
        - pq.sendRequest({
        - '  url: `${baseUrl}/interface/${sysId}/hospital/${hospId}/buildings/${bldgId}/departments`,'
        - '  method: "POST",'
        - '  headers: {'
        - '    Authorization: `Bearer ${idToken}`,'
        - '    "Content-Type": "application/json"'
        - '  },'
        - '  body: {'
        - '    mode: "raw",'
        - '    raw: JSON.stringify({'
        - '      id: deptId,'
        - '      force: true'
        - '    })'
        - '  }'
        - '}, {timeout: 10000}, (err, res) => {'
        - '  if (err) {'
        - '    console.warn("Department linking failed", err);'
        - '    return;'
        - '  }'
        - '  if (res.code !== 200) {'
        - '    console.warn("Department linking failed with status code:", res.code, res.text());'
        - '    return;'
        - '  }'
        - '  console.log("Department linked successfully:", res.json());'
        - '});'
        - ''
type: request
