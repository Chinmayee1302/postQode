id: 19802579-d990-4f3c-88cb-6d98770d21bf
name: createFloorID
request:
  url:
    raw: >-
      {{API_Base_URL}}/interface/{{SYSTEM_ID}}/hospital/{{HospitalId}}/buildings/{{BuildingId}}/floors
    host:
      - '{{API_Base_URL}}'
    path:
      - interface
      - '{{SYSTEM_ID}}'
      - hospital
      - '{{HospitalId}}'
      - buildings
      - '{{BuildingId}}'
      - floors
  method: POST
  headers:
    - description: ''
      disabled: false
      key: Cache-Control
      value: no-cache
    - description: ''
      disabled: false
      key: Accept
      value: '*/*'
    - description: ''
      disabled: false
      key: Accept-Encoding
      value: gzip, deflate
    - description: ''
      disabled: false
      key: Connection
      value: keep-alive
  body:
    mode: raw
    modeOfBody: JSON
    raw: "{\r\n  \"name\": \"{{floorDetails.floorName}}\",\r\n  \"data\": {\r\n    \"name\": \"{{floorDetails.floorName}}\",\r\n    \"floorNumber\": \"{{floorDetails.floorNumber}}\",\r\n    \"abbreviation\": \"{{floorDetails.floorNumber}}\",\r\n    \"location\": {\r\n      \"building\": {\r\n        \"id\": \"{{BuildingId}}\",\r\n        \"name\": \"{{buildingDetails.buildingName}}\"\r\n      },\r\n      \"hospital\": {\r\n        \"id\": \"{{HospitalId}}\",\r\n        \"name\": \"{{hospitalDetails.hospitalName}}\"\r\n      }\r\n    },\r\n    \"floorPlan\": \"test-floor.geojson\",\r\n    \"geoJson\": {{geoJsonEscaped}}\r\n  }\r\n}\r\n"
  auth:
    type: bearer
    bearer:
      token: '{{idToken}}'
events:
  - listen: prerequest
    script:
      type: javascript
      exec:
        - "const floorResponse=pq.environment.get(\"roomDetails\")\r"
        - "const room1Name = floorResponse.roomName_1;\r"
        - "const room2Name = floorResponse.roomName_2;\r"
        - "const roomType = floorResponse.roomType;\r"
        - " const geoJson= `{\"type\":\"Feature\",\"bbox\":[-117.2573850339,32.9919326446,-117.2567672814,32.9924188269],\"properties\":{},\"geometry\":{\"type\":\"Polygon\",\"coordinates\":[[[-117.2573850339,32.9919326446],[-117.2567672814,32.9919326446],[-117.2567672814,32.9924188269],[-117.2573850339,32.9924188269],[-117.2573850339,32.9919326446]]]},\"floorPlan\":{\"type\":\"FeatureCollection\",\"name\":\"Rooms\",\"features\":[{\"type\":\"Feature\",\"geometry\":{\"type\":\"Polygon\",\"coordinates\":[[[-117.2567801716,32.9919700738],[-117.2567802873,32.9919700442],[-117.2567802676,32.9919699897],[-117.256790479,32.9919673747],[-117.2568391117,32.9919670862],[-117.2568391158,32.9919672568],[-117.256845524,32.9919672188],[-117.2568455283,32.9919677307],[-117.2568557858,32.9919676698],[-117.2568557815,32.991967158],[-117.2568563888,32.9919671544],[-117.2568563874,32.9919669838],[-117.2568569273,32.9919669806],[-117.2568569248,32.9919670375],[-117.2568636761,32.9919669974],[-117.2568634008,32.9919340414],[-117.2568431926,32.9919342181],[-117.2568432165,32.9919370774],[-117.2568370755,32.9919371139],[-117.2568370512,32.9919341976],[-117.2568371187,32.9919341972],[-117.2568371163,32.9919339129],[-117.2567672814,32.9919343271],[-117.2567801716,32.9919700738]]]},\"properties\":{\"RoomNumber\":\"${room1Name}\",\"RoomName\":\"${room1Name}\",\"RoomType\":\"${roomType}\"}},{\"type\":\"Feature\",\"geometry\":{\"type\":\"Polygon\",\"coordinates\":[[[-117.2568203856,32.9919698135],[-117.2568197782,32.9919698171],[-117.2568197744,32.9919693621],[-117.2567908688,32.9919695336],[-117.2567828024,32.9919715993],[-117.2567840587,32.9919750832],[-117.2567797971,32.9919761745],[-117.256791613,32.9920089419],[-117.2568200361,32.9920087733],[-117.2568198281,32.9919838643],[-117.2568198956,32.9919838639],[-117.2568198504,32.9919784613],[-117.2568204578,32.9919784577],[-117.2568203856,32.9919698135]]]},\"properties\":{\"RoomNumber\":\"${room2Name}\",\"RoomName\":\"${room2Name}\",\"RoomType\":\"${roomType}\"}}]}}`\r"
        - "pq.variables.set(\"geoJsonEscaped\", JSON.stringify(geoJson))\r"
        - ''
  - listen: test
    script:
      type: javascript
      exec:
        - "const resp = pq.response.json();\r"
        - "pq.environment.set('floorId' , resp.id)\r"
        - "const floorId  = pq.environment.get('floorId')\r"
        - "const baseUrl  = pq.globals.get('API_Base_URL');\r"
        - "const sysId    = pq.globals.get('SYSTEM_ID');\r"
        - "const hospId   = pq.environment.get('HospitalId');\r"
        - "const bldgId   = pq.environment.get(\"BuildingId\");\r"
        - "const deptId   = pq.environment.get(\"departmentID\");\r"
        - "const idToken = pq.globals.get(\"idToken\");\r"
        - "const floorName = pq.environment.get('floorDetails.floorName')\r"
        - "const roomName = pq.environment.get('roomDetails.roomName_1')\r"
        - "const buildingName=pq.environment.get('buildingDetails.buildingName')\r"
        - "const hospitalName=pq.environment.get('hospitalDetails.hospitalName')\r"
        - "const geoJson  =JSON.parse(resp.data.geoJson);\r"
        - "const features = geoJson.floorPlan || [];\r"
        - "pq.sendRequest({\r"
        - "    url:`${baseUrl}/interface/${sysId}/hospital/buildings/${bldgId}/floors/${floorId}?test=true`,\r"
        - "    headers: {\r"
        - "                    Authorization: `Bearer ${idToken}`,\r"
        - "                    'Content-Type': 'application/json'\r"
        - "    }\r"
        - "})\r"
        - "features.features.forEach((feature, idx) => {\r"
        - "  // POST /rooms\r"
        - "  pq.sendRequest({\r"
        - "    url   : `${baseUrl}/interface/${sysId}/hospital/${hospId}/buildings/${bldgId}/floors/${floorId}/rooms`,\r"
        - "    method: 'POST',\r"
        - "    headers: {\r"
        - "                    Authorization: `Bearer ${idToken}`,\r"
        - "                    'Content-Type': 'application/json'\r"
        - "    },\r"
        - "    body  : {\r"
        - "      mode: 'raw',\r"
        - "      raw : JSON.stringify({\r"
        - "        name: feature.properties.RoomNumber,\r"
        - "        data: {\r"
        - "          geoshape  : JSON.stringify(feature),      \r"
        - "          roomNumber: feature.properties.RoomNumber,\r"
        - "          roomType  : feature.properties.RoomType,\r"
        - "          mapLabel  : feature.properties.RoomName\r"
        - "        }\r"
        - "      })\r"
        - "    }\r"
        - "  }, (err, res) => {\r"
        - "    if (err || res.code != 200) {\r"
        - "      console.log(pq.request.url)\r"
        - "      console.warn(`Room ${idx + 1} failed`, err || res.text());\r"
        - "      console.log(res)\r"
        - "      return;\r"
        - "    }else{\r"
        - "        console.log(res.json(),\"Room created\")\r"
        - "    }\r"
        - "    const roomId = res.json().id;\r"
        - "    console.log(`Room ${roomId} created`);\r"
        - "    // POST /departments/{deptId}/rooms  â†’ link\r"
        - "    pq.sendRequest({\r"
        - "      url   : `${baseUrl}/interface/${sysId}/hospital/${hospId}/departments/${deptId}/rooms`,\r"
        - "      method: 'POST',\r"
        - "      headers: {\r"
        - "                    Authorization: `Bearer ${idToken}`,\r"
        - "                    'Content-Type': 'application/json'\r"
        - "    },\r"
        - "      body  : { mode: 'raw', raw: JSON.stringify({ id: roomId, force: true }) }\r"
        - "    }, (err2, res2) => {\r"
        - "      if (err2 || res2.code >= 400) {\r"
        - "        console.warn(`Linking room ${roomId} failed`, err2 || res2.text());\r"
        - "      } else {\r"
        - "        console.log(`Room ${roomId} linked to department`);\r"
        - "      }\r"
        - "    });\r"
        - "  });\r"
        - "});\r"
        - "\r"
        - "\r"
        - "// console.log(roomName)\r"
        - "// const options = {\r"
        - "//     method: 'POST',\r"
        - "//     url: `${baseUrl}/interface/${sysId}/hospital/${hospId}/rooms.search`,\r"
        - "//     headers: {\r"
        - "//         'sec-ch-ua-platform': '\"macOS\"',\r"
        - "//         'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwcmoiOiI1NXptcEphMlE3dnlqdWxORjcySks2IiwiaWF0IjoxNzY0MjY1Njk5LCJleHAiOjE3NjQzNTIwOTksImF1ZCI6IkxvX2xuVXhGTDNadk1uRk41ZU1qRmlDVXYxeEZxRi1IIiwiaXNzIjoiaHR0cHM6Ly9kZXYtY294LWhlYWx0aC1pbWFnaW5lLWFwaS5sZXZlcmVnZS5jb20iLCJzdWIiOiI2QmE2VW1HTVZHb0R4dnhFbnVoVHFpIn0.hn4HGzyjyE9lJl2dFlAKhzXjKKF9MGlJle38Mm0fD04',\r"
        - "//         'Referer': 'https://dev-cognosos.web.app/',\r"
        - "//         'sec-ch-ua': '\"Chromium\";v=\"142\", \"Google Chrome\";v=\"142\", \"Not_A Brand\";v=\"99\"',\r"
        - "//         'sec-ch-ua-mobile': '?0',\r"
        - "//         'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',\r"
        - "//         'Accept': 'application/json',\r"
        - "//         'Content-Type': 'application/json'\r"
        - "//     },\r"
        - "//     auth: {\r"
        - "//         type: 'bearer',\r"
        - "//         bearer: {\r"
        - "//             token: idToken\r"
        - "//         }\r"
        - "//     },\r"
        - "//     body: {\r"
        - "//         mode: 'raw',\r"
        - "//         modeOfBody: 'JSON',\r"
        - "//         raw: JSON.stringify({ \"limit\": 100, \"offset\": 0, \"filter\": { \"type\": \"logical\", \"operator\": \"and\", \"conditions\": [{ \"type\": \"logical\", \"operator\": \"and\", \"conditions\": [{ \"type\": \"equals\", \"fieldType\": \"string\", \"empty\": false, \"field\": \"data/floor/name\", \"value\": [floorName], \"floorId\": floorId }] }, { \"type\": \"groupedText\", \"value\": roomName }] }, \"sort\": [{ \"field\": \"lastModified\", \"order\": \"desc\" }], \"nextToken\": null })\r"
        - "//     }\r"
        - "// }\r"
        - "\r"
        - "// pq.sendRequest(options, function (err, response) {\r"
        - "//     if (err) {\r"
        - "//         console.log(err);\r"
        - "//     } else {\r"
        - "//         console.log(response.json());\r"
        - "//         const id = response.json().items[0].id\r"
        - "//         pq.environment.set(\"roomId\", id);\r"
        - "//         console.log(pq.environment.get(\"roomId\"));\r"
        - "//     }\r"
        - // });
type: request
