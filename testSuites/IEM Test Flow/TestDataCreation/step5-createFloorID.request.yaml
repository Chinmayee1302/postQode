id: 43dc0d9b-5c5f-4ead-8680-3054ab1deafb
name: step5-createFloorID
request:
  url:
    raw: >-
      {{API_Base_URL}}/interface/{{SYSTEM_ID}}/hospital/{{EquipmentManagement.hospitalDetails.hospitalId}}/buildings/{{EquipmentManagement.buildingDetails.buildingId}}/floors
    host:
      - '{{API_Base_URL}}'
    path:
      - interface
      - '{{SYSTEM_ID}}'
      - hospital
      - '{{EquipmentManagement.hospitalDetails.hospitalId}}'
      - buildings
      - '{{EquipmentManagement.buildingDetails.buildingId}}'
      - floors
  method: POST
  headers:
    - key: Content-Type
      value: application/json
  body:
    mode: raw
    modeOfBody: JSON
    raw: "{\r\n  \"name\": \"{{EquipmentManagement.floorDetails.floorName}}\",\r\n  \"data\": {\r\n    \"name\": \"{{EquipmentManagement.floorDetails.floorName}}\",\r\n    \"floorNumber\": \"{{EquipmentManagement.floorDetails.floorNumber}}\",\r\n    \"abbreviation\": \"{{EquipmentManagement.floorDetails.floorNumber}}\",\r\n    \"location\": {\r\n      \"building\": {\r\n        \"id\": \"{{EquipmentManagement.buildingDetails.buildingId}}\",\r\n        \"name\": \"{{EquipmentManagement.buildingDetails.buildingName}}\"\r\n      },\r\n      \"hospital\": {\r\n        \"id\": \"{{EquipmentManagement.hospitalDetails.hospitalId}}\",\n        \"name\": \"{{EquipmentManagement.hospitalDetails.hospitalName}}\"\r\n      }\r\n    },\r\n    \"floorPlan\": \"test-floor.geojson\",\r\n    \"geoJson\": {{geoJsonEscaped}}\r\n  }\r\n}\r\n"
  auth:
    type: bearer
    bearer:
      token: '{{idToken}}'
events:
  - listen: prerequest
    script:
      type: javascript
      exec:
        - >-
          const
          floorResponse=pq.environment.get("EquipmentManagement.roomDetails")
        - const room1Name = floorResponse.roomName_1;
        - const room2Name = floorResponse.roomName_2;
        - const roomType = floorResponse.roomType;
        - ' const geoJson= `{"type":"Feature","bbox":[-117.2573850339,32.9919326446,-117.2567672814,32.9924188269],"properties":{},"geometry":{"type":"Polygon","coordinates":[[[-117.2573850339,32.9919326446],[-117.2567672814,32.9919326446],[-117.2567672814,32.9924188269],[-117.2573850339,32.9924188269],[-117.2573850339,32.9919326446]]]},"floorPlan":{"type":"FeatureCollection","name":"Rooms","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-117.2567801716,32.9919700738],[-117.2567802873,32.9919700442],[-117.2567802676,32.9919699897],[-117.256790479,32.9919673747],[-117.2568391117,32.9919670862],[-117.2568391158,32.9919672568],[-117.256845524,32.9919672188],[-117.2568455283,32.9919677307],[-117.2568557858,32.9919676698],[-117.2568557815,32.991967158],[-117.2568563888,32.9919671544],[-117.2568563874,32.9919669838],[-117.2568569273,32.9919669806],[-117.2568569248,32.9919670375],[-117.2568636761,32.9919669974],[-117.2568634008,32.9919340414],[-117.2568431926,32.9919342181],[-117.2568432165,32.9919370774],[-117.2568370755,32.9919371139],[-117.2568370512,32.9919341976],[-117.2568371187,32.9919341972],[-117.2568371163,32.9919339129],[-117.2567672814,32.9919343271],[-117.2567801716,32.9919700738]]]},"properties":{"RoomNumber":"${room1Name}","RoomName":"${room1Name}","RoomType":"${roomType}"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-117.2568203856,32.9919698135],[-117.2568197782,32.9919698171],[-117.2568197744,32.9919693621],[-117.2567908688,32.9919695336],[-117.2567828024,32.9919715993],[-117.2567840587,32.9919750832],[-117.2567797971,32.9919761745],[-117.256791613,32.9920089419],[-117.2568200361,32.9920087733],[-117.2568198281,32.9919838643],[-117.2568198956,32.9919838639],[-117.2568198504,32.9919784613],[-117.2568204578,32.9919784577],[-117.2568203856,32.9919698135]]]},"properties":{"RoomNumber":"${room2Name}","RoomName":"${room2Name}","RoomType":"${roomType}"}}]}}`'
        - pq.variables.set("geoJsonEscaped", JSON.stringify(geoJson))
        - ''
  - listen: test
    script:
      type: javascript
      exec:
        - const resp = pq.response.json();
        - >-
          pq.environment.set('EquipmentManagement.floorDetails.floorId' ,
          resp.id)
        - >-
          const floorId  =
          pq.environment.get('EquipmentManagement.floorDetails.floorId')
        - const baseUrl  = pq.globals.get('API_Base_URL');
        - const sysId    = pq.globals.get('SYSTEM_ID');
        - >-
          const hospId   =
          pq.environment.get('EquipmentManagement.hospitalDetails.hospitalId');
        - >-
          const bldgId   =
          pq.environment.get("EquipmentManagement.buildingDetails.buildingId");
        - >-
          const deptId   =
          pq.environment.get("EquipmentManagement.departmentDetails.departmentID");
        - const idToken = pq.globals.get("idToken");
        - >-
          const floorName =
          pq.environment.get('EquipmentManagement.floorDetails.floorName')
        - const geoJson  =JSON.parse(resp.data.geoJson);
        - const features = geoJson.floorPlan || [];
        - pq.sendRequest({
        - '    url:`${baseUrl}/interface/${sysId}/hospital/buildings/${bldgId}/floors/${floorId}?test=true`,'
        - '    headers: {'
        - '                    Authorization: `Bearer ${idToken}`,'
        - '                    ''Content-Type'': ''application/json'''
        - '    }'
        - '})'
        - features.features.forEach((feature, idx) => {
        - '  // POST /rooms'
        - '  pq.sendRequest({'
        - '    url   : `${baseUrl}/interface/${sysId}/hospital/${hospId}/buildings/${bldgId}/floors/${floorId}/rooms`,'
        - '    method: ''POST'','
        - '    headers: {'
        - '                    Authorization: `Bearer ${idToken}`,'
        - '                    ''Content-Type'': ''application/json'''
        - '    },'
        - '    body  : {'
        - '      mode: ''raw'','
        - '      raw : JSON.stringify({'
        - '        name: feature.properties.RoomNumber,'
        - '        data: {'
        - '          geoshape  : JSON.stringify(feature),      '
        - '          roomNumber: feature.properties.RoomNumber,'
        - '          roomType  : feature.properties.RoomType,'
        - '          mapLabel  : feature.properties.RoomName'
        - '        }'
        - '      })'
        - '    }'
        - '  }, (err, res) => {'
        - '    if (err || res.code != 200) {'
        - '      console.log(pq.request.url)'
        - '      console.warn(`Room ${idx + 1} failed`, err || res.text());'
        - '      console.log(res)'
        - '      return;'
        - '    }else{'
        - '        console.log(res.json(),"Room created")'
        - '    }'
        - '    const roomId = res.json().id;'
        - '    pq.environment.set(`EquipmentManagement.roomDetails.roomId`,roomId)'
        - '    console.log(`Room ${roomId} created`);'
        - '    // POST /departments/{deptId}/rooms  â†’ link'
        - '    pq.sendRequest({'
        - '      url   : `${baseUrl}/interface/${sysId}/hospital/${hospId}/departments/${deptId}/rooms`,'
        - '      method: ''POST'','
        - '      headers: {'
        - '                    Authorization: `Bearer ${idToken}`,'
        - '                    ''Content-Type'': ''application/json'''
        - '    },'
        - '      body  : { mode: ''raw'', raw: JSON.stringify({ id: roomId, force: true }) }'
        - '    }, (err2, res2) => {'
        - '      if (err2 || res2.code >= 400) {'
        - '        console.warn(`Linking room ${roomId} failed`, err2 || res2.text());'
        - '      } else {'
        - '        console.log(`Room ${roomId} linked to department`);'
        - '      }'
        - '    });'
        - '  });'
        - '});'
type: request
disabled: false
