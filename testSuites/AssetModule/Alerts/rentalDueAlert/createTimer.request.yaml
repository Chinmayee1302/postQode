id: 8021f245-e097-40e3-88de-96126bd3ad53
name: createTimer
request:
  url:
    raw: '{{API_Base_URL}}/project/{{PROJECT_ID}}/timer'
    host:
      - '{{API_Base_URL}}'
    path:
      - project
      - '{{PROJECT_ID}}'
      - timer
  method: POST
  headers:
    - key: accept
      value: application/json
  body:
    mode: raw
    modeOfBody: JSON
    raw: "\r\n{\r\n            \"name\": \"Automation Timer test\",\r\n            \"timer\": {\r\n              \"type\": \"once\",\r\n              \"delay\": 1000\r\n            },\r\n            \"action\": {\r\n              \"type\": \"publishTopic\",\r\n              \"topic\": \"prosightRulesActions\",\r\n              \"message\": {{msg}}\r\n            }\r\n}"
  auth:
    type: bearer
    bearer:
      token: '{{levidToken}}'
events:
  - listen: prerequest
    script:
      type: javascript
      exec:
        - "const projectId = pq.globals.get(\"PROJECT_ID\");\r"
        - "const assetBlueprintId = pq.globals.get(\"ASSET_BLUEPRINT_ID\");\r"
        - "const systemId = pq.globals.get(\"SYSTEM_ID\");\r"
        - "const assetName = pq.testSuiteVariables.get(\"assetName\");\r"
        - "const assetId = pq.environment.get(\"AssetManagement.asset2.assetId\");\r"
        - "const assetType = pq.environment.get(\"AssetManagement.asset2.assetType\");\r"
        - "const departmentName = pq.environment.get(\"AssetManagement.departmentName\");\r"
        - "const departmentID = pq.environment.get(\"AssetManagement.departmentID\");\r"
        - "const floorName = pq.environment.get(\"AssetManagement.floorDetails.floorName\");\r"
        - "const floorID = pq.environment.get(\"AssetManagement.floorDetails.floorId\");\r"
        - "const locationName = pq.environment.get(\"AssetManagement.locationName\");\r"
        - "const locationID = pq.environment.get(\"AssetManagement.locationDetails.room1\");\r"
        - "const deviceId = pq.environment.get(\"AssetManagement.asset2.assetlevId\");\r"
        - "\r"
        - "const hardwareExternalId=pq.environment.get(\"AssetManagement.hardwareExternalId\")\r"
        - "\r"
        - "const msg = {\r"
        - "    blueprintId: assetBlueprintId,\r"
        - "    deviceId: deviceId,\r"
        - "    systemId: systemId,\r"
        - "    projectId: projectId,\r"
        - "    templateId: \"@assetRentalDueDate\",\r"
        - "    application: \"assets\",\r"
        - "    alertType: \"Rental Due\",\r"
        - "    alertPriority: 6,\r"
        - "    deviceExternalId: assetId,\r"
        - "    deviceName: assetName,\r"
        - "    deviceType: assetType,\r"
        - "    deviceHardwareExternalId: hardwareExternalId,\r"
        - "    objectType: \"asset\",\r"
        - "    time: new Date().getTime(),\r"
        - "    type: \"simpleAlertMsg\",\r"
        - "    data: [],\r"
        - "    deviceLocation: {\r"
        - "        building: {\r"
        - "            id: pq.environment.get(\"AssetManagement.buildingDetails.BuildingId\"),\r"
        - "            name: pq.environment.get(\"AssetManagement.buildingDetails.buildingName\"),\r"
        - "        },\r"
        - "        department: {\r"
        - "            id: departmentID,\r"
        - "            name: departmentName,\r"
        - "        },\r"
        - "        floor: {\r"
        - "            id: floorID,\r"
        - "            name: floorName,\r"
        - "        },\r"
        - "        room: {\r"
        - "            id: locationID,\r"
        - "            name: locationName,\r"
        - "        },\r"
        - "    },\r"
        - "};\r"
        - "\r"
        - pq.variables.set("msg", JSON.stringify(msg));
  - listen: test
    script:
      type: javascript
      exec:
        - "const response=pq.response.json()\r"
        - pq.environment.set("rentalDue",response.id)
type: request
