id: 735989d3-b4c4-41d1-b41b-37217e5896a1
name: step2-createBuilding
request:
  url:
    raw: >-
      {{API_Base_URL}}/project/{{PROJECT_ID}}/system/{{SYSTEM_ID}}/srv/prosightApiServer/building
    host:
      - '{{API_Base_URL}}'
    path:
      - project
      - '{{PROJECT_ID}}'
      - system
      - '{{SYSTEM_ID}}'
      - srv
      - prosightApiServer
      - building
  method: POST
  headers:
    - key: sec-ch-ua-platform
      value: '"macOS"'
    - key: Referer
      value: https://staging-commercial-cox-health.firebaseapp.com/
    - key: sec-ch-ua
      value: '"Google Chrome";v="141", "Not?A_Brand";v="8", "Chromium";v="141"'
    - key: sec-ch-ua-mobile
      value: '?0'
    - key: User-Agent
      value: >-
        Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
        (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36
    - key: Accept
      value: application/json
    - key: Content-Type
      value: application/json
  body:
    mode: raw
    modeOfBody: JSON
    raw: |-
      {
        "data": {
          "hospital": {
            "systemId": "{{SYSTEM_ID}}",
            "metadata": {
              "allowedApplications": [
                "Prosight Assets",
                "Prosight Safety",
                "Prosight Environment"
              ],
              "timeZone": "{{AssetManagement.hospitalDetails.timezone}}"
            },
            "data": {
              "address": {
                "zipCode": "{{AssetManagement.hospitalDetails.zipCode}}",
                "city": "{{AssetManagement.hospitalDetails.city}}",
                "street": "{{AssetManagement.hospitalDetails.streetAddress}}",
                "state": "{{AssetManagement.hospitalDetails.state}}"
              },
              "hospitalType": "Default",
              "timezone": "{{AssetManagement.hospitalDetails.timezone}}",
              "contact": {
                "phone": "{{AssetManagement.buildingDetails.contactPhoneNumber}}",
                "name": "{{AssetManagement.buildingDetails.contactName}}",
                "email": "{{AssetManagement.buildingDetails.contactEmail}}"
              },
              "name": "{{AssetManagement.hospitalDetails.hospitalName}}",
              "position": {
                "lon": -92.016302,
                "lat": 30.222169
              },
              "openStaffDuressAlerts": {
                "test5": 0
              }
            },
            "purpose": "organization",
            "created": 1644009933179,
            "simulated": false,
            "name": "{{AssetManagement.hospitalDetails.hospitalName}}",
            "id": "{{AssetManagement.hospitalDetails.HospitalId}}",
            "lastModified": 1761556719623,
            "blueprintId": "{{hsptlBluePrintID}}",
            "projectId": "{{PROJECT_ID}}"
          },
          "name": "{{AssetManagement.buildingDetails.buildingName}}",
          "addressDetails": {
            "streetAddress": "{{AssetManagement.buildingDetails.streetAddress}}",
            "city": "{{AssetManagement.buildingDetails.city}}",
            "state": "{{AssetManagement.buildingDetails.state}}",
            "zipCode": "{{AssetManagement.buildingDetails.zipCode}}"
          },
          "position": {
            "lat": 32.828866,
            "lon": -86.789292
          }
        },
        "name": "{{AssetManagement.buildingDetails.buildingName}}"
      }
  auth:
    type: bearer
    bearer:
      token: '{{idToken}}'
events:
  - listen: prerequest
    script:
      type: javascript
      exec:
        - "const baseUrl  = pq.globals.get(\"API_Base_URL\");\r"
        - "const sysId    = pq.globals.get(\"SYSTEM_ID\");\r"
        - "const hospId   = pq.environment.get(\"AssetManagement.hospitalDetails.HospitalId\");\r"
        - "const idToken  = pq.globals.get(\"idToken\");\r"
        - "const hsptlBluePrint = pq.globals.get(\"hsptlBluePrintID\");\r"
        - "\r"
        - "const assetIds = [];\r"
        - "let url=`${baseUrl}/interface/${sysId}/hospital/${hospId}/buildings.search`\r"
        - "pq.sendRequest({\r"
        - "  url: `${baseUrl}/interface/${sysId}/hospital/${hospId}/buildings.search`,\r"
        - "  method: \"POST\",\r"
        - "  headers: {\r"
        - "    Authorization: `Bearer ${idToken}`,\r"
        - "    \"Content-Type\": \"application/json\",\r"
        - "  },\r"
        - "}, (err, res) => {\r"
        - "  if (err) {\r"
        - "    console.log(\"Request error:\", err);\r"
        - "    return;\r"
        - "  }\r"
        - "\r"
        - "  const responseBody = res.json();\r"
        - "  console.log(\"GET /assets response:\", responseBody,url);\r"
        - "\r"
        - "  if (!responseBody || !Array.isArray(responseBody.items)) {\r"
        - "    console.log(\"No items array in response, nothing to delete\");\r"
        - "    return;\r"
        - "  }\r"
        - "\r"
        - "  const targetName = pq.environment.get(\"AssetManagement.buildingDetails.buildingName\");\r"
        - "  console.log(\"Target asset name:\", targetName);\r"
        - "\r"
        - "  responseBody.items.forEach((ele) => {\r"
        - "    if (ele.name === targetName) {\r"
        - "      assetIds.push(ele.id);\r"
        - "    }\r"
        - "  });\r"
        - "\r"
        - "  console.log(\"Matched assetIds to delete:\", assetIds);\r"
        - "\r"
        - "  if (assetIds.length === 0) {\r"
        - "    console.log(\"No matching assets found, skipping deletion\");\r"
        - "    return;\r"
        - "  }\r"
        - "\r"
        - "  assetIds.forEach((assetId) => {\r"
        - "    pq.sendRequest({\r"
        - "      url: `${baseUrl}/interface/${sysId}/hospital/${hospId}/buildings/${assetId}`,\r"
        - "      method: \"DELETE\",\r"
        - "      headers: {\r"
        - "        Authorization: `Bearer ${idToken}`,\r"
        - "        \"Content-Type\": \"application/json\",\r"
        - "      },\r"
        - "      body: {\r"
        - "        mode: 'raw',\r"
        - "        raw: JSON.stringify({\r"
        - "          deleteDevice:\"force\"\r"
        - "        })\r"
        - "      }\r"
        - "    }, (err, res) => {\r"
        - "      if (err) {\r"
        - "        console.log(\"Unable to delete\", assetId, err);\r"
        - "        return;\r"
        - "      }\r"
        - "\r"
        - "      if (res.code === 200) {\r"
        - "        console.log(\"Asset deleted successfully:\", res.json());\r"
        - "      } else {\r"
        - "        console.log(\"Delete failed for\", assetId, \"status:\", res.code);\r"
        - "      }\r"
        - "    });\r"
        - "  });\r"
        - "\r"
        - "});\r"
        - ''
  - listen: test
    script:
      type: javascript
      exec:
        - let response = pq.response.json();
        - if (pq.response.code === 201) {
        - '  pq.test("Validate building details", function () {'
        - '    let buildingDetails = pq.environment.get("AssetManagement.buildingDetails");'
        - '    pq.expect(response.name).to.equal(buildingDetails.buildingName);'
        - '    pq.expect(response.data.name).to.equal(buildingDetails.buildingName);'
        - '    pq.expect(response.data.addressDetails.streetAddress).to.equal(buildingDetails.streetAddress);'
        - '    pq.expect(response.data.addressDetails.city).to.equal(buildingDetails.city);'
        - '    pq.expect(response.data.addressDetails.state).to.equal(buildingDetails.state);'
        - '    pq.expect(response.data.addressDetails.zipCode).to.equal(buildingDetails.zipCode);'
        - '  });'
        - '  pq.environment.set("AssetManagement.buildingDetails.BuildingId", response.id);'
        - '} else {'
        - '  console.log("building not found",response);'
        - '}'
type: request
disabled: false
